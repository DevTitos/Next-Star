<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Celestial Chess - Multiplayer Arena</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a2a, #1a0033);
            color: #00f3ff;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00f3ff;
            padding-bottom: 20px;
        }

        .game-title {
            font-size: 3em;
            background: linear-gradient(45deg, #00f3ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 243, 255, 0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8888ff;
            font-size: 1.2em;
        }

        .game-area {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-panel {
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #00f3ff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }

        .player-title {
            text-align: center;
            margin-bottom: 15px;
            color: #00f3ff;
            font-size: 1.3em;
        }

        .energy-bar {
            height: 20px;
            background: #002244;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f3ff, #ff00ff);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .timer-section {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 0, 0, 0.2);
            border-radius: 10px;
            text-align: center;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .timer.warning {
            color: #ffaa00;
            animation: pulse 1s infinite;
        }

        .timer.critical {
            color: #ff0000;
            animation: criticalPulse 0.5s infinite;
        }

        @keyframes criticalPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .astra-stake {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid gold;
        }

        .tech-tree {
            margin-top: 20px;
        }

        .tech-item {
            background: rgba(0, 50, 100, 0.6);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tech-item:hover {
            background: rgba(0, 100, 200, 0.8);
            transform: translateX(5px);
        }

        .tech-item.researched {
            background: rgba(0, 150, 50, 0.6);
            border-left: 4px solid #00ff88;
        }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            background: rgba(0, 243, 255, 0.1);
            border: 3px solid #00f3ff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.2);
            aspect-ratio: 1;
        }

        .board-square {
            aspect-ratio: 1;
            background: rgba(0, 50, 100, 0.3);
            border: 1px solid rgba(0, 243, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .board-square:hover {
            background: rgba(0, 243, 255, 0.2);
            transform: scale(1.05);
        }

        .board-square.quantum-tile {
            background: radial-gradient(circle, #00f3ff33, transparent);
            animation: pulse 2s infinite;
        }

        .board-square.dark-matter {
            background: radial-gradient(circle, #ff00ff33, transparent);
        }

        .board-square.wormhole {
            background: conic-gradient(from 0deg, #00f3ff, #ff00ff, #00f3ff);
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            transition: all 0.3s ease;
        }

        .piece.prime {
            background: radial-gradient(circle, #ff4444, #aa0000);
            border: 2px solid #ff8888;
        }

        .piece.fibonacci {
            background: radial-gradient(circle, #44ff44, #00aa00);
            border: 2px solid #88ff88;
        }

        .piece.square {
            background: radial-gradient(circle, #4444ff, #0000aa);
            border: 2px solid #8888ff;
        }

        .piece.composite {
            background: radial-gradient(circle, #ffff44, #aaaa00);
            border: 2px solid #ffff88;
        }

        .piece.selected {
            box-shadow: 0 0 20px gold;
            transform: scale(1.1);
        }

        .piece.valid-move {
            box-shadow: 0 0 15px #00ff00;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .action-panel {
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #ff00ff;
            border-radius: 15px;
            padding: 20px;
        }

        .action-title {
            text-align: center;
            margin-bottom: 15px;
            color: #ff00ff;
        }

        .ability-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .ability {
            background: rgba(255, 0, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ability:hover {
            background: rgba(255, 0, 255, 0.4);
            transform: translateY(-2px);
        }

        .ability.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log-panel {
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-title {
            text-align: center;
            margin-bottom: 15px;
            color: #00ff88;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        /* Multiplayer Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #0a0a2a, #1a0033);
            border: 3px solid #00f3ff;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #00f3ff;
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 1.8em;
            background: linear-gradient(45deg, #00f3ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-modal {
            background: none;
            border: none;
            color: #00f3ff;
            font-size: 2em;
            cursor: pointer;
        }

        .players-list {
            margin: 20px 0;
        }

        .player-card {
            background: rgba(0, 50, 100, 0.6);
            border: 1px solid #00f3ff;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            color: #00f3ff;
        }

        .player-stats {
            font-size: 0.9em;
            color: #8888ff;
        }

        .challenge-btn {
            background: linear-gradient(45deg, #00f3ff, #ff00ff);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .challenge-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
        }

        .stake-input {
            background: rgba(0, 50, 100, 0.6);
            border: 1px solid #00f3ff;
            border-radius: 8px;
            padding: 10px;
            color: #00f3ff;
            font-size: 1em;
            width: 100%;
            margin: 10px 0;
        }

        .stake-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00f3ff, #ff00ff);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #00f3ff;
            border: 1px solid #00f3ff;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .main-menu {
            text-align: center;
            margin-bottom: 20px;
        }

        .menu-btn {
            background: linear-gradient(45deg, #00f3ff, #ff00ff);
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .cosmic-event {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ff00ff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            z-index: 1000;
            animation: cosmicPulse 2s infinite;
        }

        @keyframes cosmicPulse {
            0%, 100% { box-shadow: 0 0 50px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 80px rgba(255, 0, 255, 0.8); }
        }

        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 243, 255, 0.3), rgba(255, 0, 255, 0.3));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .victory-message {
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 4px solid gold;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="game-title">QUANTUM CELESTIAL CHESS</h1>
            <div class="subtitle">Multiplayer Arena - Stake ASTRA & Conquer the Cosmos</div>
        </div>

        <div class="main-menu">
            <button class="menu-btn" onclick="showMultiplayerModal()">üåå FIND CELESTIAL OPPONENTS</button>
            <button class="menu-btn" onclick="startPracticeGame()">üéØ PRACTICE MODE</button>
        </div>

        <div class="game-area">
            <!-- Player 1 Panel -->
            <div class="player-panel">
                <div class="player-title">üëΩ PLAYER 1 - QUANTUM COLLECTIVE</div>
                
                <div class="timer-section">
                    <div>TIME REMAINING:</div>
                    <div class="timer" id="p1-timer">03:00</div>
                </div>
                
                <div class="energy-display">
                    <div>QUANTUM ENERGY:</div>
                    <div class="energy-bar">
                        <div class="energy-fill" id="p1-energy" style="width: 100%"></div>
                    </div>
                    <div id="p1-energy-text">100/100</div>
                </div>
                
                <div class="astra-stake">
                    <div>ASTRA STAKE: <span id="p1-astra">1,000</span></div>
                    <div>POTENTIAL WIN: <span id="p1-potential">1,800</span></div>
                </div>
                
                <div class="tech-tree">
                    <div class="tech-title">XENOTECH RESEARCH:</div>
                    <div class="tech-item" onclick="researchTech('quantum_entanglement', 1)">üîÆ Basic Teleportation</div>
                    <div class="tech-item" onclick="researchTech('temporal_engineering', 1)">‚è≥ Move Reversal</div>
                    <div class="tech-item" onclick="researchTech('reality_anchor', 1)">‚ö° Reality Anchor</div>
                </div>
            </div>

            <!-- Chess Board -->
            <div class="chess-board" id="chess-board">
                <!-- Board will be generated by JavaScript -->
            </div>

            <!-- Player 2 Panel -->
            <div class="player-panel">
                <div class="player-title">üëæ PLAYER 2 - TEMPORAL SYNDICATE</div>
                
                <div class="timer-section">
                    <div>TIME REMAINING:</div>
                    <div class="timer" id="p2-timer">03:00</div>
                </div>
                
                <div class="energy-display">
                    <div>QUANTUM ENERGY:</div>
                    <div class="energy-bar">
                        <div class="energy-fill" id="p2-energy" style="width: 100%"></div>
                    </div>
                    <div id="p2-energy-text">100/100</div>
                </div>
                
                <div class="astra-stake">
                    <div>ASTRA STAKE: <span id="p2-astra">1,000</span></div>
                    <div>POTENTIAL WIN: <span id="p2-potential">1,800</span></div>
                </div>
                
                <div class="tech-tree">
                    <div class="tech-title">XENOTECH RESEARCH:</div>
                    <div class="tech-item" onclick="researchTech('quantum_entanglement', 2)">üîÆ Basic Teleportation</div>
                    <div class="tech-item" onclick="researchTech('temporal_engineering', 2)">‚è≥ Move Reversal</div>
                    <div class="tech-item" onclick="researchTech('reality_anchor', 2)">‚ö° Reality Anchor</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="action-panel">
                <div class="action-title">QUANTUM ABILITIES</div>
                <div class="ability-grid">
                    <div class="ability" onclick="useAbility('singularity')">
                        <div>üï≥Ô∏è SINGULARITY COLLAPSE</div>
                        <div>Cost: 25 Energy</div>
                    </div>
                    <div class="ability" onclick="useAbility('temporal_loop')">
                        <div>‚è≥ TEMPORAL LOOP</div>
                        <div>Cost: 30 Energy</div>
                    </div>
                    <div class="ability" onclick="useAbility('quantum_tunnel')">
                        <div>üåÄ QUANTUM TUNNEL</div>
                        <div>Cost: 20 Energy</div>
                    </div>
                    <div class="ability" onclick="useAbility('reality_anchor')">
                        <div>‚ö° REALITY ANCHOR</div>
                        <div>Cost: 15 Energy</div>
                    </div>
                </div>
            </div>

            <div class="log-panel">
                <div class="log-title">QUANTUM BATTLE LOG</div>
                <div id="battle-log">
                    <div class="log-entry">üåå Welcome to Quantum Celestial Chess Arena!</div>
                    <div class="log-entry">üéØ Select an opponent to begin cosmic warfare</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Multiplayer Modal -->
    <div class="modal" id="multiplayer-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üåå CELESTIAL ARENA</h2>
                <button class="close-modal" onclick="closeMultiplayerModal()">&times;</button>
            </div>
            
            <div class="stake-section">
                <h3>SET YOUR STAKE</h3>
                <input type="number" class="stake-input" id="stake-amount" placeholder="Enter ASTRA amount" min="100" max="10000" value="1000">
                <div style="color: #8888ff; font-size: 0.9em; margin-top: 5px;">
                    Platform fee: 10% | Winner gets 90% of total stake
                </div>
            </div>
            
            <div class="players-list">
                <h3>AVAILABLE CELESTIAL COMMANDERS</h3>
                <div id="players-container">
                    <!-- Players will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeMultiplayerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createChallenge()">Create Challenge Room</button>
            </div>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div class="modal" id="challenge-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ö° CHALLENGE SENT</h2>
                <button class="close-modal" onclick="closeChallengeModal()">&times;</button>
            </div>
            
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 1.2em; margin-bottom: 10px;">
                    Challenging: <span id="challenged-player">Quantum_Warlord</span>
                </div>
                <div style="color: gold; font-size: 1.1em;">
                    Stake: <span id="challenge-stake">1,000</span> ASTRA
                </div>
                <div style="margin: 20px 0;">
                    <div class="timer" id="challenge-timer">30</div>
                    <div>Waiting for response...</div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="cancelChallenge()">Cancel Challenge</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Game State
        const gameState = {
            currentPlayer: 1,
            selectedPiece: null,
            players: {
                1: { 
                    energy: 100, 
                    tech: [], 
                    pieces: [],
                    timer: 180, // 3 minutes in seconds
                    astra: 1000,
                    connected: true
                },
                2: { 
                    energy: 100, 
                    tech: [], 
                    pieces: [],
                    timer: 180,
                    astra: 1000,
                    connected: true
                }
            },
            board: [],
            turn: 1,
            gameActive: false,
            gameMode: 'practice', // practice, ranked, challenge
            stakeAmount: 1000,
            timerInterval: null,
            challengeTimeout: null
        };

        // Available players for challenges
        const availablePlayers = [
            { id: 1, name: "Quantum_Warlord", rating: 2450, wins: 156, online: true },
            { id: 2, name: "Temporal_Master", rating: 2320, wins: 134, online: true },
            { id: 3, name: "Cosmic_Strategist", rating: 2180, wins: 89, online: true },
            { id: 4, name: "Nebula_Queen", rating: 2650, wins: 201, online: false },
            { id: 5, name: "Singularity_Knight", rating: 1950, wins: 67, online: true }
        ];

        // Initialize stars background
        function initStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 5 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Initialize game board
        function initBoard() {
            const board = document.getElementById('chess-board');
            board.innerHTML = '';
            
            const specialTiles = {
                '2,2': 'quantum-tile',
                '5,5': 'dark-matter', 
                '1,7': 'wormhole',
                '6,1': 'wormhole'
            };

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = 'board-square';
                    square.dataset.row = row;
                    square.dataset.col = col;
                    
                    const tileKey = `${row},${col}`;
                    if (specialTiles[tileKey]) {
                        square.classList.add(specialTiles[tileKey]);
                    }
                    
                    square.addEventListener('click', () => handleSquareClick(row, col));
                    board.appendChild(square);
                }
            }

            setupPieces();
        }

        // Setup initial pieces
        function setupPieces() {
            // Clear existing pieces
            gameState.players[1].pieces = [];
            gameState.players[2].pieces = [];

            // Player 1 pieces (bottom)
            placePiece(6, 0, 7, 1);
            placePiece(6, 1, 8, 1);
            placePiece(6, 2, 16, 1);
            placePiece(6, 3, 12, 1);
            placePiece(7, 0, 23, 1);
            placePiece(7, 1, 21, 1);
            placePiece(7, 2, 36, 1);
            placePiece(7, 3, 18, 1);

            // Player 2 pieces (top)
            placePiece(0, 4, 41, 2);
            placePiece(0, 5, 55, 2);
            placePiece(0, 6, 64, 2);
            placePiece(0, 7, 24, 2);
            placePiece(1, 4, 17, 2);
            placePiece(1, 5, 13, 2);
            placePiece(1, 6, 49, 2);
            placePiece(1, 7, 28, 2);

            updateBoardVisual();
        }

        // Start practice game
        function startPracticeGame() {
            gameState.gameMode = 'practice';
            gameState.stakeAmount = 0;
            startGame();
        }

        // Start a new game
        function startGame() {
            gameState.gameActive = true;
            gameState.currentPlayer = 1;
            gameState.turn = 1;
            
            // Reset timers
            gameState.players[1].timer = 180;
            gameState.players[2].timer = 180;
            gameState.players[1].energy = 100;
            gameState.players[2].energy = 100;
            
            updateTimers();
            updateEnergyDisplays();
            updateAstraDisplays();
            
            // Start timer
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(updateGameTimers, 1000);
            
            addLogEntry("üöÄ Quantum battle initiated! " + 
                       (gameState.gameMode === 'practice' ? "Practice Mode" : 
                        `Stake: ${gameState.stakeAmount} ASTRA`));
        }

        // Update game timers with energy penalty
        function updateGameTimers() {
            if (!gameState.gameActive) return;

            const currentPlayer = gameState.currentPlayer;
            const opponent = currentPlayer === 1 ? 2 : 1;
            
            // Deduct time from current player
            gameState.players[currentPlayer].timer--;
            
            // Apply energy penalty if timer is low
            if (gameState.players[currentPlayer].timer <= 30) {
                // Critical time - deduct 2 energy per second
                gameState.players[currentPlayer].energy = Math.max(0, 
                    gameState.players[currentPlayer].energy - 2);
            } else if (gameState.players[currentPlayer].timer <= 60) {
                // Warning time - deduct 1 energy per second
                gameState.players[currentPlayer].energy = Math.max(0, 
                    gameState.players[currentPlayer].energy - 1);
            }
            
            // Check for timeout
            if (gameState.players[currentPlayer].timer <= 0) {
                endGame(opponent, "Time Over - Quantum Energy Depleted");
            }
            
            updateTimers();
            updateEnergyDisplays();
        }

        // Update timer displays
        function updateTimers() {
            Object.keys(gameState.players).forEach(player => {
                const timerElement = document.getElementById(`p${player}-timer`);
                const seconds = gameState.players[player].timer;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                
                // Update timer color based on remaining time
                timerElement.className = 'timer';
                if (seconds <= 30) {
                    timerElement.classList.add('critical');
                } else if (seconds <= 60) {
                    timerElement.classList.add('warning');
                }
            });
        }

        // Show multiplayer modal
        function showMultiplayerModal() {
            document.getElementById('multiplayer-modal').style.display = 'block';
            populatePlayersList();
        }

        function closeMultiplayerModal() {
            document.getElementById('multiplayer-modal').style.display = 'none';
        }

        // Populate available players list
        function populatePlayersList() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            
            availablePlayers.forEach(player => {
                if (player.online) {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'player-card';
                    playerCard.innerHTML = `
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-stats">
                                Rating: ${player.rating} | Wins: ${player.wins}
                            </div>
                        </div>
                        <button class="challenge-btn" onclick="sendChallenge(${player.id})">
                            ‚ö° Challenge
                        </button>
                    `;
                    container.appendChild(playerCard);
                }
            });
        }

        // Send challenge to player
        function sendChallenge(playerId) {
            const player = availablePlayers.find(p => p.id === playerId);
            const stakeAmount = parseInt(document.getElementById('stake-amount').value) || 1000;
            
            if (stakeAmount < 100) {
                alert('Minimum stake is 100 ASTRA');
                return;
            }
            
            gameState.stakeAmount = stakeAmount;
            document.getElementById('challenged-player').textContent = player.name;
            document.getElementById('challenge-stake').textContent = stakeAmount.toLocaleString();
            
            closeMultiplayerModal();
            document.getElementById('challenge-modal').style.display = 'block';
            
            // Start challenge timeout
            let challengeTime = 30;
            document.getElementById('challenge-timer').textContent = challengeTime;
            
            gameState.challengeTimeout = setInterval(() => {
                challengeTime--;
                document.getElementById('challenge-timer').textContent = challengeTime;
                
                if (challengeTime <= 0) {
                    cancelChallenge();
                    addLogEntry("‚è∞ Challenge to " + player.name + " expired");
                }
            }, 1000);
            
            addLogEntry(`‚ö° Challenge sent to ${player.name} for ${stakeAmount} ASTRA`);
        }

        // Accept challenge (simulated)
        function acceptChallenge() {
            clearInterval(gameState.challengeTimeout);
            document.getElementById('challenge-modal').style.display = 'none';
            gameState.gameMode = 'challenge';
            startGame();
            addLogEntry("üéØ Challenge accepted! Game starting...");
        }

        function cancelChallenge() {
            clearInterval(gameState.challengeTimeout);
            document.getElementById('challenge-modal').style.display = 'none';
            addLogEntry("‚ùå Challenge cancelled");
        }

        function closeChallengeModal() {
            cancelChallenge();
        }

        // Create challenge room
        function createChallengeRoom() {
            const stakeAmount = parseInt(document.getElementById('stake-amount').value) || 1000;
            gameState.stakeAmount = stakeAmount;
            closeMultiplayerModal();
            addLogEntry(`üåå Challenge room created with ${stakeAmount} ASTRA stake`);
            // In real implementation, this would create a room others could join
        }

        // Update ASTRA displays
        function updateAstraDisplays() {
            const potentialWin = Math.floor(gameState.stakeAmount * 2 * 0.9); // 90% of total stake
            
            document.getElementById('p1-astra').textContent = gameState.stakeAmount.toLocaleString();
            document.getElementById('p2-astra').textContent = gameState.stakeAmount.toLocaleString();
            document.getElementById('p1-potential').textContent = potentialWin.toLocaleString();
            document.getElementById('p2-potential').textContent = potentialWin.toLocaleString();
        }

        // Enhanced victory function with ASTRA distribution
        function endGame(winner, reason) {
            gameState.gameActive = false;
            clearInterval(gameState.timerInterval);
            
            if (gameState.gameMode !== 'practice') {
                const platformFee = Math.floor(gameState.stakeAmount * 2 * 0.1); // 10% fee
                const winnerPrize = Math.floor(gameState.stakeAmount * 2 * 0.9); // 90% to winner
                
                addLogEntry(`üèÜ ${getPlayerName(winner)} VICTORY! Reason: ${reason}`);
                addLogEntry(`üí∞ ${getPlayerName(winner)} wins ${winnerPrize.toLocaleString()} ASTRA`);
                addLogEntry(`‚ö° Platform fee: ${platformFee.toLocaleString()} ASTRA (for cosmic improvements)`);
                
                // Update player ASTRA (in real implementation, this would be on-chain)
                gameState.players[winner].astra += winnerPrize;
                gameState.players[winner === 1 ? 2 : 1].astra -= gameState.stakeAmount;
            } else {
                addLogEntry(`üèÜ ${getPlayerName(winner)} wins practice game!`);
            }
            
            setTimeout(() => {
                alert(`QUANTUM VICTORY!\n${getPlayerName(winner)} has achieved ${reason}!` +
                      (gameState.gameMode !== 'practice' ? 
                       `\n\nüí∞ Prize: ${Math.floor(gameState.stakeAmount * 2 * 0.9).toLocaleString()} ASTRA` : ''));
            }, 1000);
        }

        // Existing game functions (placePiece, getNumberType, handleSquareClick, etc.)
        // ... [Previous game logic functions remain the same] ...

        // Initialize game
        window.onload = function() {
            initStars();
            initBoard();
            addLogEntry("üåå Quantum Celestial Chess Arena initialized!");
            addLogEntry("üéØ Challenge opponents or practice your cosmic strategies!");
        };

        // Placeholder functions for existing game logic
        function placePiece(row, col, number, player) {
            const piece = {
                number,
                player,
                row,
                col,
                type: getNumberType(number)
            };
            
            gameState.players[player].pieces.push(piece);
        }

        function getNumberType(number) {
            if (isPrime(number)) return 'prime';
            if (isFibonacci(number)) return 'fibonacci';
            if (isPerfectSquare(number)) return 'square';
            return 'composite';
        }

        function isPrime(num) {
            for (let i = 2; i <= Math.sqrt(num); i++) {
                if (num % i === 0) return false;
            }
            return num > 1;
        }

        function isFibonacci(num) {
            return [1, 2, 3, 5, 8, 13, 21, 34, 55].includes(num);
        }

        function isPerfectSquare(num) {
            return [1, 4, 9, 16, 25, 36, 49, 64].includes(num);
        }

        function updateBoardVisual() {
            const squares = document.querySelectorAll('.board-square');
            squares.forEach(square => {
                square.innerHTML = '';
                square.classList.remove('valid-move');
            });

            [1, 2].forEach(player => {
                gameState.players[player].pieces.forEach(piece => {
                    const square = document.querySelector(`[data-row="${piece.row}"][data-col="${piece.col}"]`);
                    if (square) {
                        const pieceElement = document.createElement('div');
                        pieceElement.className = `piece ${piece.type}`;
                        pieceElement.textContent = piece.number;
                        if (gameState.selectedPiece === piece) {
                            pieceElement.classList.add('selected');
                        }
                        square.appendChild(pieceElement);
                    }
                });
            });
        }

        function handleSquareClick(row, col) {
            if (!gameState.gameActive) return;

            const piece = getPieceAt(row, col);
            
            if (piece && piece.player === gameState.currentPlayer) {
                gameState.selectedPiece = piece;
                showValidMoves(piece);
            } else if (gameState.selectedPiece) {
                attemptMove(gameState.selectedPiece, row, col);
            }
            
            updateBoardVisual();
        }

        function getPieceAt(row, col) {
            for (let player of [1, 2]) {
                const piece = gameState.players[player].pieces.find(p => 
                    p.row === row && p.col === col
                );
                if (piece) return piece;
            }
            return null;
        }

        function showValidMoves(piece) {
            const moves = calculateValidMoves(piece);
            moves.forEach(([row, col]) => {
                const square = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (square) {
                    square.classList.add('valid-move');
                }
            });
        }

        function calculateValidMoves(piece) {
            const moves = [];
            const { type, row, col } = piece;

            switch (type) {
                case 'prime':
                    for (let i = -1; i <= 1; i += 2) {
                        for (let j = -1; j <= 1; j += 2) {
                            addMoveIfValid(moves, row + i, col + j);
                            addMoveIfValid(moves, row + i * 2, col + j);
                            addMoveIfValid(moves, row + i, col + j * 2);
                        }
                    }
                    break;
                case 'fibonacci':
                    for (let i = -2; i <= 2; i++) {
                        if (i !== 0) {
                            addMoveIfValid(moves, row + i, col);
                            addMoveIfValid(moves, row, col + i);
                        }
                    }
                    break;
                case 'square':
                    for (let i = -2; i <= 2; i += 2) {
                        for (let j = -2; j <= 2; j += 2) {
                            if (i !== 0 || j !== 0) {
                                addMoveIfValid(moves, row + i, col + j);
                            }
                        }
                    }
                    break;
                default:
                    for (let i = -1; i <= 1; i++) {
                        for (let j = -1; j <= 1; j++) {
                            if (i !== 0 || j !== 0) {
                                addMoveIfValid(moves, row + i, col + j);
                            }
                        }
                    }
            }
            
            return moves;
        }

        function addMoveIfValid(moves, row, col) {
            if (row >= 0 && row < 8 && col >= 0 && col < 8) {
                const targetPiece = getPieceAt(row, col);
                if (!targetPiece || targetPiece.player !== gameState.currentPlayer) {
                    moves.push([row, col]);
                }
            }
        }

        function attemptMove(piece, targetRow, targetCol) {
            const validMoves = calculateValidMoves(piece);
            const isValidMove = validMoves.some(([row, col]) => 
                row === targetRow && col === targetCol
            );

            if (isValidMove) {
                const targetPiece = getPieceAt(targetRow, targetCol);
                
                if (targetPiece) {
                    gameState.players[targetPiece.player].pieces = 
                        gameState.players[targetPiece.player].pieces.filter(p => p !== targetPiece);
                    addLogEntry(`üí• ${getPlayerName(gameState.currentPlayer)} captured ${targetPiece.number}!`);
                }

                piece.row = targetRow;
                piece.col = targetCol;
                
                addLogEntry(`üöÄ ${getPlayerName(gameState.currentPlayer)} moved ${piece.number} to (${targetRow},${targetCol})`);
                
                checkVictoryConditions();
                
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                gameState.turn++;
                gameState.selectedPiece = null;
                
                gameState.players[1].energy = Math.min(100, gameState.players[1].energy + 10);
                gameState.players[2].energy = Math.min(100, gameState.players[2].energy + 10);
                updateEnergyDisplays();
                
                if (Math.random() < 0.3) {
                    triggerCosmicEvent();
                }
            }
        }

        function checkVictoryConditions() {
            const p1Core = gameState.players[1].pieces.find(p => p.number === 23);
            const p2Core = gameState.players[2].pieces.find(p => p.number === 17);
            
            if (!p1Core) {
                endGame(2, "Reality Core Destruction");
            } else if (!p2Core) {
                endGame(1, "Reality Core Destruction");
            }
        }

        function researchTech(tech, player) {
            if (!gameState.players[player].tech.includes(tech)) {
                gameState.players[player].tech.push(tech);
                addLogEntry(`üî¨ ${getPlayerName(player)} researched ${tech.replace('_', ' ').toUpperCase()}!`);
                
                document.querySelectorAll(`.tech-item`).forEach(item => {
                    if (item.textContent.includes(tech.replace('_', ' '))) {
                        item.classList.add('researched');
                    }
                });
            }
        }

        function useAbility(ability) {
            const player = gameState.currentPlayer;
            const cost = getAbilityCost(ability);
            
            if (gameState.players[player].energy >= cost) {
                gameState.players[player].energy -= cost;
                updateEnergyDisplays();
                addLogEntry(`‚ö° ${getPlayerName(player)} used ${ability.replace('_', ' ').toUpperCase()}!`);
            }
        }

        function getAbilityCost(ability) {
            const costs = {
                'singularity': 25,
                'temporal_loop': 30,
                'quantum_tunnel': 20,
                'reality_anchor': 15
            };
            return costs[ability] || 0;
        }

        function triggerCosmicEvent() {
            const events = [
                "üåû SOLAR FLARE: Quantum abilities cost 50% less energy this turn!",
                "üå™Ô∏è NEBULA STORM: Movement range reduced by 50%!",
                "üí´ QUANTUM ANOMALY: Pieces randomly teleport!",
                "üåÄ TEMPORAL RIFT: Players swap control for 2 turns!",
                "‚ö° DARK MATTER SURGE: All special abilities disabled!"
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            addLogEntry(`üåå COSMIC EVENT: ${event}`);
        }

        function getPlayerName(player) {
            return player === 1 ? "QUANTUM COLLECTIVE" : "TEMPORAL SYNDICATE";
        }

        function addLogEntry(message) {
            const log = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateEnergyDisplays() {
            document.getElementById('p1-energy').style.width = `${gameState.players[1].energy}%`;
            document.getElementById('p1-energy-text').textContent = `${gameState.players[1].energy}/100`;
            document.getElementById('p2-energy').style.width = `${gameState.players[2].energy}%`;
            document.getElementById('p2-energy-text').textContent = `${gameState.players[2].energy}/100`;
        }

        // Simulate opponent accepting challenge (for demo)
        setTimeout(() => {
            if (Math.random() < 0.3) {
                acceptChallenge();
            }
        }, 5000);
    </script>
</body>
</html>