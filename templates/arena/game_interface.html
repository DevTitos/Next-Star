{% extends 'arena/base.html' %}

{% block title %}Astral Arena - Game {{ game.game_id }}{% endblock %}

{% block extra_css %}
<style>
    .game-container {
        display: grid;
        grid-template-columns: 300px 1fr 300px;
        gap: 20px;
        margin-bottom: 30px;
    }

    .player-panel {
        background: rgba(0, 20, 40, 0.8);
        border: 2px solid var(--neon-blue);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
    }

    .player-title {
        text-align: center;
        margin-bottom: 15px;
        color: var(--neon-blue);
        font-size: 1.3em;
    }

    .energy-bar {
        height: 20px;
        background: #002244;
        border-radius: 10px;
        margin: 10px 0;
        overflow: hidden;
    }

    .energy-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink));
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .timer-section {
        margin: 15px 0;
        padding: 10px;
        background: rgba(255, 0, 0, 0.2);
        border-radius: 10px;
        text-align: center;
    }

    .timer {
        font-size: 1.5em;
        font-weight: bold;
        color: #ff4444;
        text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }

    .timer.warning {
        color: #ffaa00;
        animation: pulse 1s infinite;
    }

    .timer.critical {
        color: #ff0000;
        animation: criticalPulse 0.5s infinite;
    }

    @keyframes criticalPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .astra-stake {
        background: rgba(255, 215, 0, 0.2);
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        text-align: center;
        border: 1px solid var(--cosmic-gold);
    }

    .chess-board {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(8, 1fr);
        gap: 2px;
        background: rgba(0, 243, 255, 0.1);
        border: 3px solid var(--neon-blue);
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 0 50px rgba(0, 243, 255, 0.2);
        aspect-ratio: 1;
    }

    .board-square {
        aspect-ratio: 1;
        background: rgba(0, 50, 100, 0.3);
        border: 1px solid rgba(0, 243, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .board-square:hover {
        background: rgba(0, 243, 255, 0.2);
        transform: scale(1.05);
    }

    .board-square.quantum-tile {
        background: radial-gradient(circle, var(--neon-blue)33, transparent);
        animation: pulse 2s infinite;
    }

    .board-square.dark-matter {
        background: radial-gradient(circle, var(--neon-pink)33, transparent);
    }

    .board-square.wormhole {
        background: conic-gradient(from 0deg, var(--neon-blue), var(--neon-pink), var(--neon-blue));
    }

    .piece {
        width: 80%;
        height: 80%;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px black;
        transition: all 0.3s ease;
    }

    .piece.prime {
        background: radial-gradient(circle, #ff4444, #aa0000);
        border: 2px solid #ff8888;
    }

    .piece.fibonacci {
        background: radial-gradient(circle, #44ff44, #00aa00);
        border: 2px solid #88ff88;
    }

    .piece.square {
        background: radial-gradient(circle, #4444ff, #0000aa);
        border: 2px solid #8888ff;
    }

    .piece.composite {
        background: radial-gradient(circle, #ffff44, #aaaa00);
        border: 2px solid #ffff88;
    }

    .piece.selected {
        box-shadow: 0 0 20px var(--cosmic-gold);
        transform: scale(1.1);
    }

    .piece.valid-move {
        box-shadow: 0 0 15px var(--alien-green);
    }

    .controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 30px;
    }

    .action-panel {
        background: rgba(0, 20, 40, 0.8);
        border: 2px solid var(--neon-pink);
        border-radius: 15px;
        padding: 20px;
    }

    .action-title {
        text-align: center;
        margin-bottom: 15px;
        color: var(--neon-pink);
    }

    .ability-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .ability {
        background: rgba(255, 0, 255, 0.2);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .ability:hover {
        background: rgba(255, 0, 255, 0.4);
        transform: translateY(-2px);
    }

    .ability.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .log-panel {
        background: rgba(0, 20, 40, 0.8);
        border: 2px solid var(--alien-green);
        border-radius: 15px;
        padding: 20px;
        max-height: 200px;
        overflow-y: auto;
    }

    .log-title {
        text-align: center;
        margin-bottom: 15px;
        color: var(--alien-green);
    }

    .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid var(--alien-green);
        background: rgba(0, 255, 136, 0.1);
    }

    .game-over-modal {
        text-align: center;
        padding: 40px;
    }

    .victory-title {
        font-size: 2em;
        color: var(--cosmic-gold);
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <!-- Player 1 Panel -->
    <div class="player-panel">
        <div class="player-title">
            {% if player_number == 1 %}üéØ YOU - {% endif %}{{ game.player1.username }}
        </div>
        
        <div class="timer-section">
            <div>TIME REMAINING:</div>
            <div class="timer" id="p1-timer">03:00</div>
        </div>
        
        <div class="energy-display">
            <div>QUANTUM ENERGY:</div>
            <div class="energy-bar">
                <div class="energy-fill" id="p1-energy" style="width: {{ game.player1_energy }}%"></div>
            </div>
            <div id="p1-energy-text">{{ game.player1_energy }}/100</div>
        </div>
        
        <div class="astra-stake">
            <div>ASTRA STAKE: {{ game.stake_amount }}</div>
            <div>POTENTIAL WIN: {{ game.winner_reward|default:game.stake_amount }}</div>
        </div>
    </div>

    <!-- Game Board -->
    <div class="chess-board" id="chess-board">
        <!-- Board will be populated by JavaScript -->
    </div>

    <!-- Player 2 Panel -->
    <div class="player-panel">
        <div class="player-title">
            {% if player_number == 2 %}üéØ YOU - {% endif %}{{ game.player2.username }}
        </div>
        
        <div class="timer-section">
            <div>TIME REMAINING:</div>
            <div class="timer" id="p2-timer">03:00</div>
        </div>
        
        <div class="energy-display">
            <div>QUANTUM ENERGY:</div>
            <div class="energy-bar">
                <div class="energy-fill" id="p2-energy" style="width: {{ game.player2_energy }}%"></div>
            </div>
            <div id="p2-energy-text">{{ game.player2_energy }}/100</div>
        </div>
        
        <div class="astra-stake">
            <div>ASTRA STAKE: {{ game.stake_amount }}</div>
            <div>POTENTIAL WIN: {{ game.winner_reward|default:game.stake_amount }}</div>
        </div>
    </div>
</div>

<div class="controls">
    <div class="action-panel">
        <div class="action-title">QUANTUM ABILITIES</div>
        <div class="ability-grid">
            <div class="ability" onclick="useAbility('singularity')">
                <div>üï≥Ô∏è SINGULARITY COLLAPSE</div>
                <div>Cost: 25 Energy</div>
            </div>
            <div class="ability" onclick="useAbility('temporal_loop')">
                <div>‚è≥ TEMPORAL LOOP</div>
                <div>Cost: 30 Energy</div>
            </div>
            <div class="ability" onclick="useAbility('quantum_tunnel')">
                <div>üåÄ QUANTUM TUNNEL</div>
                <div>Cost: 20 Energy</div>
            </div>
            <div class="ability" onclick="useAbility('reality_anchor')">
                <div>‚ö° REALITY ANCHOR</div>
                <div>Cost: 15 Energy</div>
            </div>
        </div>
    </div>

    <div class="log-panel">
        <div class="log-title">QUANTUM BATTLE LOG</div>
        <div id="battle-log">
            <div class="log-entry">üåå Game {{ game.game_id }} initialized</div>
            <div class="log-entry">üéØ {{ game.player1.username }} vs {{ game.player2.username }}</div>
            <div class="log-entry">üí∞ Stake: {{ game.stake_amount }} ASTRA each</div>
        </div>
    </div>
</div>

<!-- Game Over Modal -->
<div class="modal" id="game-over-modal">
    <div class="modal-content">
        <div class="game-over-modal">
            <div class="victory-title" id="victory-message">VICTORY!</div>
            <div id="victory-details"></div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="returnToLobby()">Return to Lobby</button>
                <button class="btn btn-secondary" onclick="rematch()">Request Rematch</button>
            </div>
        </div>
    </div>
</div>






<!-- Add this to game_interface.html -->
{% if game.mode == 'practice' %}
<div class="practice-mode-indicator">
    <div class="ai-info">
        <h3>ü§ñ Practice Mode</h3>
        <p>Playing against: <strong>{{ game.board_state.ai_name }}</strong></p>
        <p>Difficulty: <span class="difficulty-badge">{{ game.board_state.ai_difficulty|title }}</span></p>
        <div class="practice-tips">
            <button class="btn btn-sm" onclick="showPracticeTips()">üí° Show Tips</button>
            <button class="btn btn-sm" onclick="restartPractice()">üîÑ Restart</button>
        </div>
    </div>
</div>

<!-- Practice Tips Modal -->
<div class="modal" id="practice-tips-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí° Practice Mode Tips</h2>
            <button class="close-modal" onclick="closeModal('practice-tips-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="dynamic-tips">
                <!-- Tips will be loaded based on game state -->
            </div>
        </div>
    </div>
</div>

<script>
    function showPracticeTips() {
        // Load context-specific tips
        const tips = getContextualTips();
        document.getElementById('dynamic-tips').innerHTML = tips;
        openModal('practice-tips-modal');
    }
 
    function restartPractice() {
        if (confirm('Restart practice game?')) {
            // Logic to restart the game
            window.location.reload();
        }
    }

    function getContextualTips() {
        // Return tips based on current game state
        return `
            <div class="tip-section">
                <h4>Current Situation Tips:</h4>
                <ul>
                    <li>Watch how the AI positions its pieces</li>
                    <li>Try different piece combinations</li>
                    <li>Experiment with ability timing</li>
                    <li>Learn from the AI's move patterns</li>
                </ul>
            </div>
        `;
    }
</script>
{% endif %}




<script>
    {% block extra_js %}
    const gameId = "{{ game.game_id }}";
    const playerNumber = {{ player_number }};
    let selectedPiece = null;
    let gameActive = {{ game.status == 'active'|yesno:"true,false" }};

    // Initialize game board
    function initGameBoard() {
        const board = document.getElementById('chess-board');
        board.innerHTML = '';
        
        const boardState = {{ game.board_state|safe }};
        
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                const square = document.createElement('div');
                square.className = 'board-square';
                square.dataset.row = row;
                square.dataset.col = col;
                
                // Add special tile classes
                const tileKey = `${row},${col}`;
                if (boardState.special_tiles && boardState.special_tiles[tileKey]) {
                    square.classList.add(boardState.special_tiles[tileKey]);
                }
                
                square.addEventListener('click', () => handleSquareClick(row, col));
                board.appendChild(square);
            }
        }
        
        updateBoardVisual();
    }

    // Update board with pieces
    function updateBoardVisual() {
        const boardState = {{ game.board_state|safe }};
        const squares = document.querySelectorAll('.board-square');
        
        squares.forEach(square => {
            square.innerHTML = '';
            square.classList.remove('valid-move');
        });

        if (boardState.pieces) {
            boardState.pieces.forEach(piece => {
                const square = document.querySelector(`[data-row="${piece.row}"][data-col="${piece.col}"]`);
                if (square) {
                    const pieceElement = document.createElement('div');
                    pieceElement.className = `piece ${piece.type}`;
                    pieceElement.textContent = piece.number;
                    if (selectedPiece && selectedPiece.row === piece.row && selectedPiece.col === piece.col) {
                        pieceElement.classList.add('selected');
                    }
                    square.appendChild(pieceElement);
                }
            });
        }
    }

    // Handle square clicks
    async function handleSquareClick(row, col) {
        if (!gameActive) return;
        
        const boardState = {{ game.board_state|safe }};
        const piece = boardState.pieces.find(p => p.row === row && p.col === col);
        
        if (piece && piece.player === playerNumber) {
            // Select own piece
            selectedPiece = piece;
            showValidMoves(piece);
        } else if (selectedPiece) {
            // Try to move selected piece
            await attemptMove(selectedPiece, row, col);
        }
        
        updateBoardVisual();
    }

    // Show valid moves
    function showValidMoves(piece) {
        // This would calculate valid moves based on piece type
        // For now, show adjacent squares as valid
        const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];
        
        directions.forEach(([dRow, dCol]) => {
            const newRow = piece.row + dRow;
            const newCol = piece.col + dCol;
            
            if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                const square = document.querySelector(`[data-row="${newRow}"][data-col="${newCol}"]`);
                if (square) {
                    square.classList.add('valid-move');
                }
            }
        });
    }

    // Attempt to make a move
    async function attemptMove(piece, targetRow, targetCol) {
        const result = await makeMove(piece.row, piece.col, targetRow, targetCol);
        
        if (result.success) {
            selectedPiece = null;
            updateGameState(result.game_state);
            
            if (result.victory && result.victory.game_over) {
                showGameOver(result.victory);
            }
        } else {
            alert(result.message);
        }
    }

    // Make move via AJAX
    async function makeMove(fromRow, fromCol, toRow, toCol) {
        const result = await makeRequest("{% url 'arena_make_move' %}", {
            game_id: gameId,
            from_row: fromRow,
            from_col: fromCol,
            to_row: toRow,
            to_col: toCol
        });
        return result;
    }

    // Use ability
    async function useAbility(ability) {
        if (!gameActive) return;
        
        const result = await makeRequest("{% url 'arena_use_ability' %}", {
            game_id: gameId,
            ability: ability
        });
        
        if (result.success) {
            addLogEntry(`‚ö° Used ${ability.toUpperCase()}`);
            updateGameState(result.game_state);
        } else {
            alert(result.message);
        }
    }

    // Update game state from server response
    function updateGameState(gameState) {
        // Update timers
        document.getElementById('p1-timer').textContent = formatTime(gameState.player1_time);
        document.getElementById('p2-timer').textContent = formatTime(gameState.player2_time);
        
        // Update energy
        document.getElementById('p1-energy').style.width = gameState.player1_energy + '%';
        document.getElementById('p1-energy-text').textContent = gameState.player1_energy + '/100';
        document.getElementById('p2-energy').style.width = gameState.player2_energy + '%';
        document.getElementById('p2-energy-text').textContent = gameState.player2_energy + '/100';
        
        // Update timer colors
        updateTimerColors();
    }

    // Format time as MM:SS
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Update timer warning colors
    function updateTimerColors() {
        const p1Timer = document.getElementById('p1-timer');
        const p2Timer = document.getElementById('p2-timer');
        
        const p1Seconds = parseInt(p1Timer.textContent.split(':')[0]) * 60 + parseInt(p1Timer.textContent.split(':')[1]);
        const p2Seconds = parseInt(p2Timer.textContent.split(':')[0]) * 60 + parseInt(p2Timer.textContent.split(':')[1]);
        
        p1Timer.className = 'timer';
        p2Timer.className = 'timer';
        
        if (p1Seconds <= 30) p1Timer.classList.add('critical');
        else if (p1Seconds <= 60) p1Timer.classList.add('warning');
        
        if (p2Seconds <= 30) p2Timer.classList.add('critical');
        else if (p2Seconds <= 60) p2Timer.classList.add('warning');
    }

    // Add log entry
    function addLogEntry(message) {
        const log = document.getElementById('battle-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = message;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    // Show game over modal
    function showGameOver(victory) {
        gameActive = false;
        const modal = document.getElementById('game-over-modal');
        const message = document.getElementById('victory-message');
        const details = document.getElementById('victory-details');
        
        if (victory.winner === playerNumber) {
            message.textContent = 'üèÜ VICTORY!';
            message.style.color = 'var(--cosmic-gold)';
        } else {
            message.textContent = 'üíÄ DEFEAT';
            message.style.color = '#ff4444';
        }
        
        details.innerHTML = `
            <p>Victory Type: ${victory.victory_type}</p>
            <p>ASTRA Won: {{ game.winner_reward }}</p>
        `;
        
        modal.style.display = 'block';
    }

    // Return to lobby
    function returnToLobby() {
        window.location.href = "{% url 'arena_lobby' %}";
    }

    // Request rematch
    async function rematch() {
        const result = await makeRequest("{% url 'arena_create_challenge' %}", {
            opponent_id: {% if player_number == 1 %}{{ game.player2.id }}{% else %}{{ game.player1.id }}{% endif %},
            stake_amount: {{ game.stake_amount }}
        });
        
        if (result.success) {
            alert('Rematch challenge sent!');
            returnToLobby();
        }
    }

    // Initialize game
    document.addEventListener('DOMContentLoaded', function() {
        initGameBoard();
        updateTimerColors();
        
        // Simulate game updates (in real implementation, this would be WebSockets)
        setInterval(async () => {
            if (gameActive) {
                // This would check for game state updates
            }
        }, 1000);
    });
    {% endblock %}
</script>
{% endblock %}