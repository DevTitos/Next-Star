<!-- Forge Key Modal -->
<div class="modal" id="forgeKeyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-hammer"></i> Forge Star Key</h2>
            <button class="modal-close" onclick="closeModal('forgeKeyModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form action="{% url 'submit_keys' %}" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">Select Convergence</label>
                    <select class="form-input" name="draw_id" id="drawSelection">
                        {% for draw in active_draws %}
                        <option value="{{draw.id}}">{{draw.title}} Convergence ({{draw.prize_pool}} ASTRA)</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Enter 6-Digit Cosmic Code</label>
                    <div class="key-inputs">
                        <input  name="key-1" type="text" class="key-digit" maxlength="1" oninput="moveToNextModal(this, 1)" onkeypress="return isNumberKey(event)">
                        <input  name="key-2" type="text" class="key-digit" maxlength="1" oninput="moveToNextModal(this, 2)" onkeypress="return isNumberKey(event)">
                        <input  name="key-3" type="text" class="key-digit" maxlength="1" oninput="moveToNextModal(this, 3)" onkeypress="return isNumberKey(event)">
                        <input  name="key-4" type="text" class="key-digit" maxlength="1" oninput="moveToNextModal(this, 4)" onkeypress="return isNumberKey(event)">
                        <input  name="key-5" type="text" class="key-digit" maxlength="1" oninput="moveToNextModal(this, 5)" onkeypress="return isNumberKey(event)">
                        <input  name="key-6" type="text" class="key-digit" maxlength="1" oninput="moveToNextModal(this, 6)" onkeypress="return isNumberKey(event)">
                    </div>
                    <div class="form-hint">Enter numbers 0-9 for each digit</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Star Key Parameters</label>
                    <div class="hologram" style="padding: 1rem; margin: 0;">
                        <p style="margin-bottom: 0.5rem;"><strong>Quantum Entropy Source:</strong> Hedera Consensus</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Key Strength:</strong> Quantum-Encrypted</p>
                        <p style="margin-bottom: 0.5rem;"><strong>NFT Minting:</strong> HBAR-Enabled</p>
                        <p><strong>Security Level:</strong> <span id="securityLevel">CALCULATING...</span></p>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="action-btn btn-primary" type="submit">
                        <i class="fas fa-bolt"></i> Initiate Forging
                    </button>
                    <button class="action-btn" onclick="closeModal('forgeKeyModal')">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Draw Modal (Admin Only) -->
<div class="modal" id="createDrawModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-plus"></i> Create Cosmic Convergence</h2>
            <button class="modal-close" onclick="closeModal('createDrawModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form action="{% url 'create_draw' %}" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">Convergence Title</label>
                    <input type="text" class="form-input" name="title" required placeholder="Enter convergence name" id="drawTitle">
                </div>

                <div class="form-group">
                    <label class="form-label">Convergence Symbol</label>
                    <input type="text" name="symbol" class="form-input" required placeholder="Enter convergence symbol eg. NBL-1" id="drawTitle">
                </div>

                <div class="form-group">
                    <label class="form-label">Convergence Status</label>
                    <select name="status" required id="status" class="form-input">
                        <option value="upcoming">Upcoming</option>
                        <option value="active">Active</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Prize Pool (ASTRA)</label>
                    <input type="number" name="prize_pool" required class="form-input" placeholder="Enter prize amount" id="prizePool" min="1000" step="1000">
                </div>

                <div class="form-group">
                    <label class="form-label">Convergence Date</label>
                    <input name="draw_datetime" type="datetime-local" required class="form-input" id="drawDateTime">
                </div>

                <div class="form-group">
                    <label class="form-label">Quantum Parameters</label>
                    <div class="hologram" style="padding: 1rem; margin: 0;">
                        <p style="margin-bottom: 0.5rem;"><strong>Entropy Source:</strong> Multi-dimensional</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Security Level:</strong> Quantum-Resistant</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Transparency:</strong> Hedera-Anchored</p>
                        <p><strong>Consensus:</strong> Hashgraph-Validated</p>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="action-btn btn-primary" type="submit">
                        <i class="fas fa-rocket"></i> Launch Convergence
                    </button>
                    <button class="action-btn" onclick="closeModal('createDrawModal')">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- M-Pesa Purchase ASTRA Modal -->
<div class="modal" id="purchaseAstraModal">
    <div class="modal-content cosmic-modal">
        <div class="modal-header">
            <div class="modal-title-section">
                <div class="token-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div>
                    <h2 class="modal-title">Acquire ASTRA Tokens</h2>
                    <p class="modal-subtitle">Fuel your cosmic journey with utility tokens</p>
                </div>
            </div>
            <button class="modal-close cosmic-close" onclick="closeModal('purchaseAstraModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form action="{% url 'buy_astra' %}" method="post">
                {% csrf_token %}
                <!-- Token Amount Selection -->
                <div class="form-group">
                    <!--label class="form-label">Select Token Package</label>
                    <div class="token-packages">
                        <div class="token-package" data-amount="100" data-price="10" onclick="selectTokenPackage(this)">
                            <div class="package-header">
                                <span class="package-name">Starter</span>
                                <span class="package-badge">Basic</span>
                            </div>
                            <div class="package-amount">1 ASTRA</div>
                            <div class="package-price">KES 100</div>
                            <div class="package-bonus">No bonus</div>
                        </div>

                        <div class="token-package recommended" data-amount="500" data-price="45" onclick="selectTokenPackage(this)">
                            <div class="package-header">
                                <span class="package-name">Explorer</span>
                                <span class="package-badge">Popular</span>
                            </div>
                            <div class="package-amount">5 ASTRA</div>
                            <div class="package-price">KES 500</div>
                            <div class="package-bonus" style="color: var(--alien-green);">+50 ASTRA (10%)</div>
                        </div>

                        <div class="token-package" data-amount="1000" data-price="80" onclick="selectTokenPackage(this)">
                            <div class="package-header">
                                <span class="package-name">Voyager</span>
                                <span class="package-badge">Best Value</span>
                            </div>
                            <div class="package-amount">10 ASTRA</div>
                            <div class="package-price">KES 1000</div>
                            <div class="package-bonus" style="color: var(--cosmic-gold);">+200 ASTRA (20%)</div>
                        </div>
                    </div-->

                    <!-- Custom Amount Input -->
                    <div class="custom-amount-section">
                        <label class="form-label">Enter Custom Amount</label>
                        <div class="custom-amount-input">
                            <input type="number" name="amount" class="form-input" placeholder="Enter amount (KSH)" id="customAstraAmount" min="50" max="10000" onchange="updateCustomAmount()">
                            <span class="input-suffix">KES</span>
                        </div>
                        <!--div class="custom-price" id="customPrice">KES 0</div-->
                    </div>
                </div>

                <!-- M-Pesa Phone Number Input -->
                <div class="form-group">
                    <label class="form-label">M-Pesa Phone Number</label>
                    <div class="phone-input-container">
                        <div class="country-code">+254</div>
                        <input type="tel" class="form-input" id="mpesaPhone" name="tel" placeholder="7XX XXX XXX" maxlength="11" oninput="formatPhoneNumber(this)">
                    </div>
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i>
                        Enter your M-Pesa registered phone number without the country code
                    </div>
                </div>

                <!-- M-Pesa Instructions -->
                <div class="mpesa-instructions">
                    <div class="instructions-header">
                        <i class="fas fa-mobile-alt"></i>
                        M-Pesa Payment Instructions
                    </div>
                    <ol class="instructions-steps">
                        <li>Enter your M-Pesa registered phone number</li>
                        <li>Click "Initiate M-Pesa Payment"</li>
                        <li>Check your phone for STK push prompt</li>
                        <li>Enter your M-Pesa PIN to complete payment</li>
                        <li>ASTRA tokens will be credited automatically</li>
                        <li>1 ASTRA = KES 100</li>
                    </ol>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions" style="color: white;">
                    <button class="action-btn btn-success cosmic-pulse" type="submit">
                        <i class="fas fa-mobile-alt"></i>
                        <span class="btn-text text-white">Initiate M-Pesa Payment</span>
                        <div class="btn-loading" id="purchaseLoading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            Initiating STK Push...
                        </div>
                    </button>
                    <button class="action-btn btn-outline" onclick="closeModal('purchaseAstraModal')">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>

                <!-- Security Notice -->
                <div class="security-notice">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure payment via M-Pesa. Your ASTRA tokens will be delivered instantly.</span>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Status Modal -->
<div class="modal" id="paymentStatusModal">
    <div class="modal-content cosmic-modal">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-mobile-alt"></i> Payment Status</h2>
            <button class="modal-close cosmic-close" onclick="closeModal('paymentStatusModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="paymentStatusContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced Modal Styles */
.cosmic-modal {
    background: linear-gradient(135deg, var(--cosmic-purple), var(--deep-space));
    border: 1px solid var(--neon-border);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(101, 78, 167, 0.3);
}

.modal-title-section {
    display: flex;
    align-items: center;
    gap: 12px;
}

.token-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--cosmic-gold), var(--alien-green));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.modal-subtitle {
    color: var(--text-muted);
    font-size: 14px;
    margin: 4px 0 0 0;
}

.cosmic-close {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--neon-border);
    border-radius: 8px;
    color: var(--text-light);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.cosmic-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
}

/* Phone Input */
.phone-input-container {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--neon-border);
    border-radius: 8px;
    overflow: hidden;
}

.country-code {
    padding: 12px 16px;
    background: rgba(16, 185, 129, 0.2);
    color: var(--alien-green);
    font-weight: 600;
    border-right: 1px solid var(--neon-border);
}

.phone-input-container .form-input {
    border: none;
    background: transparent;
    flex: 1;
}

/* Token Packages */
.token-packages {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}

.token-package {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.token-package:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--neon-border);
}

.token-package.selected {
    border-color: var(--cosmic-gold);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(101, 78, 167, 0.1));
}

.token-package.recommended {
    border-color: var(--alien-green);
    transform: scale(1.02);
}

.package-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.package-name {
    font-weight: 600;
    color: var(--text-light);
}

.package-badge {
    font-size: 10px;
    padding: 4px 8px;
    background: var(--alien-green);
    color: var(--deep-space);
    border-radius: 12px;
    font-weight: bold;
}

.package-amount {
    font-size: 18px;
    font-weight: bold;
    color: var(--cosmic-gold);
    margin-bottom: 4px;
}

.package-price {
    font-size: 14px;
    color: var(--text-light);
    margin-bottom: 4px;
}

.package-bonus {
    font-size: 12px;
    font-weight: 500;
}

/* Custom Amount Section */
.custom-amount-section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    padding: 16px;
    margin-top: 16px;
}

.custom-amount-input {
    position: relative;
    display: flex;
    align-items: center;
}

.custom-amount-input .form-input {
    padding-right: 80px;
}

.input-suffix {
    position: absolute;
    right: 12px;
    color: var(--text-muted);
    font-weight: 500;
}

.custom-price {
    text-align: center;
    font-weight: 600;
    color: var(--cosmic-gold);
    margin-top: 8px;
}

/* Enhanced Summary */
.cosmic-summary {
    background: linear-gradient(135deg, rgba(101, 78, 167, 0.2), rgba(16, 185, 129, 0.1));
    border: 1px solid var(--neon-border);
    border-radius: 12px;
    padding: 20px;
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--cosmic-gold);
    margin-bottom: 16px;
}

.summary-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.summary-item.bonus {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 12px;
}

.summary-item.total {
    font-size: 18px;
    padding-top: 12px;
}

.summary-item.cost {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-top: 12px;
    font-weight: 600;
}

/* M-Pesa Instructions */
.mpesa-instructions {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--alien-green);
    border-radius: 12px;
    padding: 16px;
    margin: 20px 0;
}

.instructions-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--alien-green);
    margin-bottom: 12px;
}

.instructions-steps {
    margin: 0;
    padding-left: 20px;
    color: var(--text-light);
}

.instructions-steps li {
    margin-bottom: 8px;
    font-size: 14px;
}

/* Enhanced Buttons */
.cosmic-pulse {
    animation: cosmicPulse 2s infinite;
}

@keyframes cosmicPulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.btn-loading {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Security Notice */
.security-notice {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--alien-green);
    border-radius: 8px;
    padding: 12px;
    margin-top: 16px;
    font-size: 12px;
    color: var(--text-muted);
}

/* Payment Status Styles */
.payment-success {
    text-align: center;
    padding: 20px;
}

.payment-success i {
    font-size: 48px;
    color: var(--alien-green);
    margin-bottom: 16px;
}

.payment-error {
    text-align: center;
    padding: 20px;
}

.payment-error i {
    font-size: 48px;
    color: #e74c3c;
    margin-bottom: 16px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .token-packages {
        grid-template-columns: 1fr;
    }
    
    .cosmic-modal {
        margin: 20px;
        width: auto;
    }
}
</style>

<script>
// JavaScript for M-Pesa integrated modal
let selectedPackage = null;
let astraPrice = 0.10; // KES 0.10 per ASTRA token

function selectTokenPackage(element) {
    // Remove selected class from all packages
    document.querySelectorAll('.token-package').forEach(pkg => {
        pkg.classList.remove('selected');
    });
    
    // Add selected class to clicked package
    element.classList.add('selected');
    selectedPackage = element;
    
    // Update summary
    updatePurchaseSummary();
    updatePurchaseButton();
}

function updateCustomAmount() {
    const customInput = document.getElementById('customAstraAmount');
    const customPrice = document.getElementById('customPrice');
    const amount = parseInt(customInput.value) || 0;
    
    if (amount >= 10) {
        const price = amount * astraPrice;
        customPrice.textContent = `KES ${price.toFixed(0)}`;
        
        // Deselect any package
        document.querySelectorAll('.token-package').forEach(pkg => {
            pkg.classList.remove('selected');
        });
        selectedPackage = null;
        
        updatePurchaseSummary();
        updatePurchaseButton();
    }
}

function formatPhoneNumber(input) {
    // Remove non-numeric characters
    let value = input.value.replace(/\D/g, '');
    
    // Format as 7XX XXX XXX
    if (value.length > 0) {
        value = value.substring(0, 9);
        if (value.length > 3) {
            value = value.substring(0, 3) + ' ' + value.substring(3);
        }
        if (value.length > 7) {
            value = value.substring(0, 7) + ' ' + value.substring(7);
        }
    }
    
    input.value = value;
    updatePurchaseButton();
}

function updatePurchaseSummary() {
    let baseAmount = 0;
    let bonus = 0;
    let cost = 0;
    
    if (selectedPackage) {
        baseAmount = parseInt(selectedPackage.dataset.amount);
        bonus = parseInt(selectedPackage.dataset.bonus) || 0;
        cost = parseInt(selectedPackage.dataset.price);
    } else {
        // Custom amount
        baseAmount = parseInt(document.getElementById('customAstraAmount').value) || 0;
        cost = baseAmount * astraPrice;
        // Calculate bonus based on amount
        if (baseAmount >= 1000) {
            bonus = Math.floor(baseAmount * 0.2); // 20% bonus
        } else if (baseAmount >= 500) {
            bonus = Math.floor(baseAmount * 0.1); // 10% bonus
        }
    }
    
    const totalAmount = baseAmount + bonus;
    
    document.getElementById('summaryAmount').textContent = `${baseAmount.toLocaleString()} ASTRA`;
    document.getElementById('summaryBonus').textContent = `+${bonus.toLocaleString()} ASTRA`;
    document.getElementById('summaryTotal').textContent = `${totalAmount.toLocaleString()} ASTRA`;
    document.getElementById('summaryCost').textContent = `KES ${cost.toFixed(0)}`;
}

function updatePurchaseButton() {
    const purchaseBtn = document.getElementById('purchaseBtn');
    const phone = document.getElementById('mpesaPhone').value.replace(/\s/g, '');
    const isValid = (selectedPackage || (parseInt(document.getElementById('customAstraAmount').value) || 0) >= 10) && 
                   phone.length === 9;
    
    purchaseBtn.disabled = !isValid;
}

function initiateMpesaPayment() {
    const purchaseBtn = document.getElementById('purchaseBtn');
    const loading = document.getElementById('purchaseLoading');
    const btnText = purchaseBtn.querySelector('.btn-text');
    
    // Get payment details
    let amount, astraAmount;
    
    if (selectedPackage) {
        amount = parseInt(selectedPackage.dataset.price);
        astraAmount = parseInt(selectedPackage.dataset.amount) + (parseInt(selectedPackage.dataset.bonus) || 0);
    } else {
        astraAmount = parseInt(document.getElementById('customAstraAmount').value);
        amount = astraAmount * astraPrice;
    }
    
    const phone = '254' + document.getElementById('mpesaPhone').value.replace(/\s/g, '');
    
    // Show loading state
    btnText.style.display = 'none';
    loading.style.display = 'flex';
    purchaseBtn.disabled = true;

    // CSRF token for Django
    const csrftoken = getCookie('csrftoken');
    
    // Make AJAX request to Django view
    fetch('/buy-astra/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `tel=${encodeURIComponent(phone)}&amount=${encodeURIComponent(amount)}`
    })
    .then(response => response.json())
    .then(data => {
        // Reset button state
        btnText.style.display = 'block';
        loading.style.display = 'none';
        purchaseBtn.disabled = false;
        
        if (data.success) {
            showPaymentStatus('success', data.message, data.manual_instructions);
            closeModal('purchaseAstraModal');
        } else {
            showPaymentStatus('error', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Reset button state
        btnText.style.display = 'block';
        loading.style.display = 'none';
        purchaseBtn.disabled = false;
        showPaymentStatus('error', 'Network error. Please try again.');
    });
}

function showPaymentStatus(type, message, manualInstructions = '') {
    const statusContent = document.getElementById('paymentStatusContent');
    
    if (type === 'success') {
        statusContent.innerHTML = `
            <div class="payment-success">
                <i class="fas fa-check-circle"></i>
                <h3 style="color: var(--alien-green); margin-bottom: 16px;">Payment Initiated Successfully!</h3>
                <p>${message}</p>
                ${manualInstructions ? `<div class="manual-instructions" style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <strong>Manual Instructions:</strong><br>${manualInstructions}
                </div>` : ''}
                <div style="margin-top: 20px;">
                    <button class="action-btn btn-success" onclick="closeModal('paymentStatusModal')">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        `;
    } else {
        statusContent.innerHTML = `
            <div class="payment-error">
                <i class="fas fa-exclamation-circle"></i>
                <h3 style="color: #e74c3c; margin-bottom: 16px;">Payment Failed</h3>
                <p>${message}</p>
                <div style="margin-top: 20px;">
                    <button class="action-btn btn-outline" onclick="closeModal('paymentStatusModal')">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="action-btn btn-success" onclick="closeModal('paymentStatusModal'); initiateMpesaPayment();" style="margin-left: 8px;">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            </div>
        `;
    }
    
    // Show status modal
    document.getElementById('paymentStatusModal').style.display = 'block';
}

// CSRF token helper function for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize modal
document.addEventListener('DOMContentLoaded', function() {
    // Select recommended package by default
    const recommendedPackage = document.querySelector('.token-package.recommended');
    if (recommendedPackage) {
        selectTokenPackage(recommendedPackage);
    }
    
    // Add input validation
    document.getElementById('mpesaPhone').addEventListener('input', updatePurchaseButton);
    document.getElementById('customAstraAmount').addEventListener('input', updatePurchaseButton);
});

// Modal close function (assuming you have this)
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}
</script>

<!-- Notifications Modal -->
<div class="modal" id="notificationsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-bell"></i> Quantum Alerts</h2>
            <button class="modal-close" onclick="closeModal('notificationsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="notifications-list">
                
                {% for alert in alerts %}
                <div class="notification-item">
                    <div class="notification-icon">
                        <i class="fas fa-{{alert.icon}}" style="color: var(--neon-magenta);"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">{{alert.title}}</div>
                        <div class="notification-message">{{alert.content}}</div>
                        <div class="notification-time">{{alert.created_at}}</div>
                    </div>
                </div>
                {% endfor %}

            </div>
            
            <div class="form-actions">
                <button class="action-btn" onclick="markAllAsRead()">
                    <i class="fas fa-check-double"></i> Mark All as Read
                </button>
                <button class="action-btn" onclick="closeModal('notificationsModal')">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-cog"></i> Quantum Settings</h2>
            <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <h3 class="settings-title"><i class="fas fa-user-astronaut"></i> Profile Settings</h3>
                <div class="form-group">
                    <label class="form-label">Cosmic Alias</label>
                    <input type="text" class="form-input" value="Cosmic Citizen" id="userAlias">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Communication Frequency</label>
                    <select class="form-input" id="commFrequency">
                        <option>Real-time Quantum Pulses</option>
                        <option>Stellar Updates (Daily)</option>
                        <option>Galactic Summaries (Weekly)</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title"><i class="fas fa-shield-alt"></i> Security Settings</h3>
                <div class="setting-toggle">
                    <span>Two-Factor Authentication</span>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-toggle">
                    <span>Quantum Encryption</span>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-toggle">
                    <span>Biometric Verification</span>
                    <label class="toggle-switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title"><i class="fas fa-palette"></i> Interface Settings</h3>
                <div class="theme-options">
                    <div class="theme-option active" data-theme="cosmic">
                        <div class="theme-preview cosmic-theme"></div>
                        <span>Cosmic Dark</span>
                    </div>
                    <div class="theme-option" data-theme="nebula">
                        <div class="theme-preview nebula-theme"></div>
                        <span>Nebula Purple</span>
                    </div>
                    <div class="theme-option" data-theme="quantum">
                        <div class="theme-preview quantum-theme"></div>
                        <span>Quantum Blue</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hologram Intensity</label>
                    <input type="range" min="0" max="100" value="75" class="slider" id="hologramIntensity">
                </div>
            </div>
            
            <div class="form-actions">
                <button class="action-btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Quantum Configuration
                </button>
                <button class="action-btn" onclick="closeModal('settingsModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Key Details Modal -->
<div class="modal" id="keyDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-key"></i> Star Key Inspection</h2>
            <button class="modal-close" onclick="closeModal('keyDetailsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="key-visualization">
                <div class="key-pattern">
                    <span class="key-digit-display">7</span>
                    <span class="key-digit-display">2</span>
                    <span class="key-digit-display">9</span>
                    <span class="key-digit-display">4</span>
                    <span class="key-digit-display">1</span>
                    <span class="key-digit-display">8</span>
                </div>
                <div class="key-serial">AK-729418-N7</div>
            </div>
            
            <div class="key-details">
                <div class="detail-item">
                    <span class="detail-label">Convergence:</span>
                    <span class="detail-value">Nebula-7</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Forged:</span>
                    <span class="detail-value">2023-11-15 14:32 UTC</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value status-active">Active</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Match Probability:</span>
                    <span class="detail-value">0.0001%</span>
                </div>
            </div>
            
            <div class="key-metadata">
                <h3>Quantum Signature</h3>
                <div class="signature-code">
                    0x8a3d7f2e1c6b5a9e4d2f7c1a8b6e5d3f2a1c7e9b4d6f8a3c2e1b7d5f9a4c6e8b2
                </div>
            </div>
            
            <div class="form-actions">
                <button class="action-btn btn-primary" onclick="shareKey()">
                    <i class="fas fa-share-alt"></i> Share Quantum Signature
                </button>
                <button class="action-btn" onclick="closeModal('keyDetailsModal')">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Draw Details Modal -->
<!--div class="modal" id="drawDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-dice"></i> Convergence Details</h2>
            <button class="modal-close" onclick="closeModal('drawDetailsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="draw-header">
                <h3 id="drawModalTitle">Nebula-7 Convergence</h3>
                <div class="draw-prize" id="drawModalPrize">150,000 ASTRA</div>
            </div>
            
            <div class="draw-stats">
                <div class="stat">
                    <div class="stat-value" id="drawParticipants">2,847</div>
                    <div class="stat-label">Participants</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="drawKeys">15,629</div>
                    <div class="stat-label">Star Keys</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="drawTime">47:32:15</div>
                    <div class="stat-label">Remaining</div>
                </div>
            </div>
            
            <div class="draw-progress">
                <div class="progress-label">Prize Pool Growth</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%;"></div>
                </div>
                <div class="progress-stats">
                    <span>Current: 150,000 ASTRA</span>
                    <span>Target: 200,000 ASTRA</span>
                </div>
            </div>
            
            <div class="winning-pattern">
                <h4>Winning Pattern</h4>
                <div class="pattern-display">
                    <span class="pattern-digit">?</span>
                    <span class="pattern-digit">?</span>
                    <span class="pattern-digit">?</span>
                    <span class="pattern-digit">?</span>
                    <span class="pattern-digit">?</span>
                    <span class="pattern-digit">?</span>
                </div>
                <div class="pattern-hint">Revealed at convergence completion</div>
            </div>
            
            <div class="form-actions">
                <button class="action-btn btn-primary" onclick="openModal('forgeKeyModal')">
                    <i class="fas fa-key"></i> Forge Star Key
                </button>
                <button class="action-btn" onclick="closeModal('drawDetailsModal')">
                    Close
                </button>
            </div>
        </div>
    </div>
</div-->

<!-- Draw Details Modal -->
<!-- Draw Details Modal -->
<div class="modal" id="drawDetailsModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('drawDetailsModal')">&times;</button>
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-dice"></i> Convergence Details</h2>
        </div>
        <div class="modal-body">
            <div class="draw-details-container">
                <!-- Draw Header -->
                <div class="draw-header" style="text-align: center; margin-bottom: 2rem;">
                    <h3 id="drawDetailTitle" style="color: var(--neon-cyan); margin-bottom: 0.5rem;">Nebula-7 Convergence</h3>
                    <div id="drawDetailSymbol" style="font-family: monospace; opacity: 0.7; margin-bottom: 1rem;">Symbol: NEB7</div>
                    <div id="drawDetailPrize" style="font-size: 2rem; color: var(--alien-green); font-weight: 700;">42,000 ASTRA</div>
                </div>

                <!-- Draw Information Grid -->
                <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div id="drawDetailStatus" class="status-badge status-active">Active</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Draw Date</div>
                        <div id="drawDetailDate" style="font-weight: 600;">2024-01-15 20:00 UTC</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Participants</div>
                        <div id="drawDetailParticipants" style="color: var(--neon-cyan); font-weight: 600;">1,247</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Your Keys</div>
                        <div id="drawDetailUserKeys" style="color: var(--alien-green); font-weight: 600;">2</div>
                    </div>
                </div>

                <!-- NFT Information -->
                <div class="nft-info" style="background: rgba(0, 255, 255, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 2rem;">
                    <h4 style="color: var(--hologram-teal); margin-bottom: 0.5rem;">
                        <i class="fas fa-cube"></i> NFT Information
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div class="info-label">Token ID</div>
                            <div id="drawDetailTokenId" style="font-family: monospace; font-size: 0.9rem;">0.0.1234567</div>
                        </div>
                        <div>
                            <div class="info-label">Contract</div>
                            <div id="drawDetailContract" style="font-family: monospace; font-size: 0.9rem;">0.0.9876543</div>
                        </div>
                    </div>
                </div>

                <!-- Star Keys Section -->
                <div class="star-keys-section">
                    <h4 style="color: var(--hologram-teal); margin-bottom: 1rem;">
                        <i class="fas fa-key"></i> Your Star Keys for this Draw
                    </h4>
                    <div id="drawStarKeysList" class="star-keys-list">
                        <!-- Star keys will be populated here -->
                        <div class="star-key-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div>
                                <span style="font-family: monospace; font-weight: 600;">SK-7B2X9F</span>
                                <span style="margin-left: 1rem; font-size: 0.8rem; opacity: 0.7;">Forged: Jan 10, 2024</span>
                            </div>
                            <span class="status-badge status-active">Active</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                    <button class="action-btn btn-primary" onclick="forgeNewKey()">
                        <i class="fas fa-key"></i> Forge New Key
                    </button>
                    <button class="action-btn" style="border-color: var(--quantum-blue); color: var(--quantum-blue);" onclick="viewOnExplorer()">
                        <i class="fas fa-external-link-alt"></i> View on Explorer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .info-label {
        font-size: 0.8rem;
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.3rem;
    }

    .star-keys-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .star-key-item {
        transition: all 0.3s ease;
    }

    .star-key-item:hover {
        background: rgba(0, 255, 255, 0.1) !important;
        transform: translateX(5px);
    }

    /* Responsive design for modal */
    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }

        .modal-actions {
            flex-direction: column;
        }

        .modal-actions .action-btn {
            width: 100%;
        }
    }
</style>


<style>
    /* Additional styles for the modals */
    .form-hint {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.5rem;
    }
    
    .purchase-summary {
        background: rgba(15, 15, 35, 0.6);
        border-radius: 10px;
        padding: 1rem;
        margin: 1.5rem 0;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .summary-item.total {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 0.5rem;
        margin-top: 0.5rem;
        font-size: 1.1rem;
    }
    
    .astra-bonus {
        font-size: 0.8rem;
        margin-top: 0.2rem;
    }
    
    .notifications-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .notification-item {
        display: flex;
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .notification-item.new {
        background: rgba(0, 255, 255, 0.05);
        border-left: 3px solid var(--neon-cyan);
    }
    
    .notification-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .notification-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
        width: 40px;
        text-align: center;
    }
    
    .notification-content {
        flex: 1;
    }
    
    .notification-title {
        font-weight: bold;
        margin-bottom: 0.3rem;
    }
    
    .notification-message {
        opacity: 0.8;
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
    }
    
    .notification-time {
        font-size: 0.8rem;
        opacity: 0.6;
    }
    
    .settings-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .settings-title {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        color: var(--neon-cyan);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .setting-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.2);
        transition: .4s;
        border-radius: 24px;
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: var(--neon-cyan);
    }
    
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    
    .theme-options {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .theme-option {
        text-align: center;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    .theme-option.active {
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid var(--neon-cyan);
    }
    
    .theme-preview {
        width: 60px;
        height: 40px;
        border-radius: 5px;
        margin-bottom: 0.5rem;
    }
    
    .cosmic-theme {
        background: linear-gradient(135deg, #050510, #0a0a1f);
        border: 1px solid var(--neon-cyan);
    }
    
    .nebula-theme {
        background: linear-gradient(135deg, #1a0a2a, #6040c0);
        border: 1px solid var(--nebula-purple);
    }
    
    .quantum-theme {
        background: linear-gradient(135deg, #001a33, #0066cc);
        border: 1px solid var(--quantum-blue);
    }
    
    .key-visualization {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .key-pattern {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .key-digit-display {
        width: 50px;
        height: 70px;
        background: rgba(0, 255, 255, 0.1);
        border: 2px solid var(--neon-cyan);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: var(--neon-cyan);
    }
    
    .key-serial {
        font-family: monospace;
        font-size: 1.2rem;
        color: var(--alien-green);
    }
    
    .key-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .detail-label {
        opacity: 0.7;
    }
    
    .status-active {
        color: var(--alien-green);
        font-weight: bold;
    }
    
    .signature-code {
        background: rgba(0, 0, 0, 0.5);
        padding: 1rem;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.8rem;
        word-break: break-all;
        margin-top: 0.5rem;
    }
    
    .draw-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .draw-prize {
        font-size: 2rem;
        color: var(--cosmic-gold);
        font-weight: bold;
        margin-top: 0.5rem;
    }
    
    .draw-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat {
        text-align: center;
        padding: 1rem;
        background: rgba(0, 255, 255, 0.05);
        border-radius: 10px;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--neon-cyan);
    }
    
    .stat-label {
        font-size: 0.8rem;
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .draw-progress {
        margin-bottom: 1.5rem;
    }
    
    .progress-label {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .progress-bar {
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--neon-cyan), var(--alien-green));
        border-radius: 5px;
    }
    
    .progress-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .winning-pattern {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .pattern-display {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin: 1rem 0;
    }
    
    .pattern-digit {
        width: 40px;
        height: 60px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid var(--neon-magenta);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--neon-magenta);
    }
    
    .pattern-hint {
        font-size: 0.8rem;
        opacity: 0.7;
    }
</style>

<script>
    // Modal functionality
    function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }
    
    function moveToNextModal(input, nextIndex) {
        if (input.value.length === 1) {
            const inputs = input.parentElement.querySelectorAll('.key-digit');
            if (nextIndex < inputs.length) {
                inputs[nextIndex].focus();
            }
        }
        
        // Update security level based on input
        updateSecurityLevel();
    }
    
    function updateSecurityLevel() {
        const inputs = document.querySelectorAll('#forgeKeyModal .key-digit');
        let filled = 0;
        inputs.forEach(input => {
            if (input.value !== '') filled++;
        });
        
        const securityLevel = document.getElementById('securityLevel');
        if (filled === 6) {
            securityLevel.textContent = 'QUANTUM SECURE';
            securityLevel.style.color = 'var(--alien-green)';
        } else if (filled >= 3) {
            securityLevel.textContent = 'HIGH SECURITY';
            securityLevel.style.color = 'var(--neon-cyan)';
        } else {
            securityLevel.textContent = 'CALCULATING...';
            securityLevel.style.color = 'var(--star-white)';
        }
    }
    
    function submitStarKey() {
        const inputs = document.querySelectorAll('#forgeKeyModal .key-digit');
        let key = '';
        let valid = true;
        
        inputs.forEach(input => {
            if (input.value === '' || isNaN(input.value)) {
                valid = false;
                input.style.borderColor = 'var(--warning-red)';
            } else {
                key += input.value;
                input.style.borderColor = 'var(--alien-green)';
            }
        });
        
        if (valid && key.length === 6) {
            // Submit to your Django view
            alert(`Star Key ${key} forged successfully!`);
            closeModal('forgeKeyModal');
            // Here you would send the key to your Django backend
            // fetch('/submit-keys/', { method: 'POST', body: JSON.stringify({star_keys: key.split('')}) })
        } else {
            alert('Please enter 6 valid digits (0-9)');
        }
    }
    
    function createNewDraw() {
        const title = document.getElementById('drawTitle').value;
        const symbol = document.getElementById('symbol').value;
        const prize = document.getElementById('prizePool').value;
        const date = document.getElementById('drawDateTime').value;
        const status = document.getElementById('status').value;
        
        if (title && prize && date && symbol && status) {
            // Show loading state
            const submitBtn = document.querySelector('#createDrawModal .modal-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Convergence...';
            submitBtn.disabled = true;

            // Prepare data for API
            const drawData = {
                title: title,
                symbol: symbol,
                prize_pool: prize,
                draw_datetime: date,
                status: status
            };

            // Send POST request to Django view
            fetch('{% url "create_draw" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken() // You'll need to implement this function
                },
                body: JSON.stringify(drawData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success handling
                    showNotification(`Convergence "${title}" created successfully with ${prize} ASTRA prize pool!`, 'success');
                    closeModal('createDrawModal');

                    // Reset form
                    document.getElementById('drawTitle').value = '';
                    document.getElementById('symbol').value = '';
                    document.getElementById('prizePool').value = '';
                    document.getElementById('drawDateTime').value = '';
                    document.getElementById('status').value = 'upcoming';

                    // Refresh the draws section if needed
                    if (document.getElementById('admin-draws').classList.contains('active')) {
                        // You might want to refresh the draws list here
                        loadAdminDraws();
                    }
                } else {
                    // Error handling
                    showNotification(`Failed to create convergence: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error creating draw:', error);
                showNotification('Network error occurred while creating convergence', 'error');
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });

        } else {
            showNotification('Please fill in all required fields', 'warning');
        }
    }

    // Helper function to get CSRF token (add this to your script)
    function getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue;
    }

    // Notification function (add this to show user feedback)
    function showNotification(message, type = 'info') {
        // Remove existing notification if any
        const existingNotification = document.getElementById('custom-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // Create notification element
        const notification = document.createElement('div');
        notification.id = 'custom-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        `;

        // Set background color based on type
        const colors = {
            success: 'var(--alien-green)',
            error: 'var(--warning-red)',
            warning: 'var(--plasma-orange)',
            info: 'var(--neon-cyan)'
        };

        notification.style.background = colors[type] || colors.info;
        notification.textContent = message;

        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = `
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
        `;
        closeBtn.onclick = () => notification.remove();
        notification.appendChild(closeBtn);

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Add this CSS for the notification animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);

    // Optional: Function to refresh admin draws list
    function loadAdminDraws() {
        // This would fetch and update the draws list in the admin section
        // You can implement this based on your needs
        console.log('Refreshing admin draws list...');
        // Example implementation:
        // fetch('')
        // .then(response => response.json())
        // .then(data => {
        //     updateDrawsTable(data.draws);
        // });
    }

    
    let selectedAstraAmount = 0;
    let selectedPaymentMethod = 'hbar';
    
    function selectAstraOption(element, amount) {
        document.querySelectorAll('.astra-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');
        selectedAstraAmount = amount;
        
        updatePurchaseSummary();
    }
    
    function selectPaymentMethod(element, method) {
        document.querySelectorAll('.payment-method').forEach(opt => {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');
        selectedPaymentMethod = method;
    }
    
    function updatePurchaseSummary() {
        let bonus = 0;
        if (selectedAstraAmount >= 25000) bonus = 2500;
        else if (selectedAstraAmount >= 10000) bonus = 750;
        else if (selectedAstraAmount >= 5000) bonus = 250;
        
        const total = selectedAstraAmount + bonus;
        const cost = selectedAstraAmount / 100; // Simple conversion for demo
        
        document.getElementById('summaryAmount').textContent = selectedAstraAmount.toLocaleString() + ' ASTRA';
        document.getElementById('summaryBonus').textContent = '+' + bonus.toLocaleString() + ' ASTRA';
        document.getElementById('summaryTotal').textContent = total.toLocaleString() + ' ASTRA';
        document.getElementById('summaryCost').textContent = '$' + cost.toLocaleString();
    }
    
    function purchaseAstra() {
        if (selectedAstraAmount > 0) {
            const wallet = document.getElementById('walletAddress').value;
            if (wallet) {
                alert(`Purchasing ${selectedAstraAmount} ASTRA via ${selectedPaymentMethod.toUpperCase()} to ${wallet}`);
                closeModal('purchaseAstraModal');
            } else {
                alert('Please enter your wallet address');
            }
        } else {
            alert('Please select an ASTRA amount');
        }
    }
    
    function markAllAsRead() {
        document.querySelectorAll('.notification-item.new').forEach(item => {
            item.classList.remove('new');
        });
        alert('All notifications marked as read');
    }
    
    function saveSettings() {
        alert('Quantum settings saved successfully!');
        closeModal('settingsModal');
    }
    
    function shareKey() {
        alert('Quantum signature shared across the cosmic network!');
    }
    
    // Theme switching
    document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            this.classList.add('active');
            
            const theme = this.getAttribute('data-theme');
            // Here you would implement theme switching logic
            console.log('Switching to theme:', theme);
        });
    });
</script>

<script>
    // Function to open draw details modal
    function viewDraw(drawId) {
        // Fetch draw details from your backend
        fetchDrawDetails(drawId).then(drawData => {
            // Populate modal with draw data
            populateDrawModal(drawData);
            // Open the modal
            openModal('drawDetailsModal');
        }).catch(error => {
            console.error('Error fetching draw details:', error);
            // Show error state
            showDrawError();
        });
    }

    function fetchDrawDetails(drawId) {
    return new Promise((resolve, reject) => {
        // Show loading state in the modal
        const modalBody = document.querySelector('#drawDetailsModal .modal-body');
        if (modalBody) {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; color: var(--neon-cyan); margin-bottom: 1rem;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h3 style="color: var(--neon-cyan);">Loading Cosmic Data...</h3>
                    <p>Retrieving convergence details from the quantum network</p>
                </div>
            `;
        }

        const csrfToken = getCSRFToken();
        
        fetch(`/api/draws/${drawId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Convergence not found in the cosmic records');
                } else if (response.status === 403) {
                    throw new Error('Quantum access denied');
                } else {
                    throw new Error(`Network error: ${response.status}`);
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Transform API response to match your modal structure
                const drawData = {
                    id: data.draw.id,
                    title: data.draw.title,
                    symbol: data.draw.symbol || 'NEB7', // Fallback to NEB7 if not provided
                    prize_pool: typeof data.draw.prize_pool === 'number' 
                        ? data.draw.prize_pool.toLocaleString() 
                        : String(data.draw.prize_pool),
                    status: data.draw.status,
                    draw_datetime: data.draw.draw_datetime,
                    participants: data.participants_count || 1247, // Fallback to your mock value
                    user_keys: data.user_keys_count || 2, // Fallback to your mock value
                    nft_token_id: data.draw.nft_token_id || data.draw.nft_id || 'Not assigned',
                    nft_contract: data.draw.nft_contract || data.draw.nft_id || 'Not available',
                    star_keys: data.user_star_keys || [
                        { serial: "SK-7B2X9F", forged_date: "2024-01-10", status: "active" }
                    ], // Fallback to your mock data
                    // Additional fields from your view
                    total_tickets_sold: data.draw.total_tickets_sold,
                    winner_wallet_id: data.draw.winner_wallet_id,
                    winning_ticket_serial: data.draw.winning_ticket_serial,
                    // ENDED draw specific data
                    winning_keys: data.winning_keys || [],
                    winner: data.winner || null
                };
                resolve(drawData);
            } else {
                throw new Error(data.error || 'Failed to retrieve convergence data');
            }
        })
        .catch(error => {
            console.error('Quantum retrieval error:', error);
            reject(error);
        });
    });
}

// Updated populateDrawModal function to handle the new data
function populateDrawModal(drawData) {
    document.getElementById('drawDetailTitle').textContent = drawData.title;
    document.getElementById('drawDetailSymbol').textContent = `Symbol: ${drawData.symbol}`;
    document.getElementById('drawDetailPrize').textContent = `${drawData.prize_pool} ASTRA`;
    
    // Update status badge
    const statusElement = document.getElementById('drawDetailStatus');
    statusElement.textContent = drawData.status.charAt(0).toUpperCase() + drawData.status.slice(1);
    statusElement.className = `status-badge status-${drawData.status.toLowerCase()}`;
    
    // Format and display draw datetime
    const drawDate = new Date(drawData.draw_datetime);
    document.getElementById('drawDetailDate').textContent = 
        drawDate.toLocaleDateString() + ' ' + drawDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    document.getElementById('drawDetailParticipants').textContent = drawData.participants.toLocaleString();
    document.getElementById('drawDetailUserKeys').textContent = drawData.user_keys;
    document.getElementById('drawDetailTokenId').textContent = drawData.nft_token_id;
    document.getElementById('drawDetailContract').textContent = drawData.nft_contract;

    // Populate star keys list
    const starKeysList = document.getElementById('drawStarKeysList');
    starKeysList.innerHTML = '';
    
    drawData.star_keys.forEach(key => {
        const keyElement = document.createElement('div');
        keyElement.className = 'star-key-item';
        keyElement.innerHTML = `
            <div>
                <span style="font-family: monospace; font-weight: 600;">${key.serial}</span>
                <span style="margin-left: 1rem; font-size: 0.8rem; opacity: 0.7;">Forged: ${formatDate(key.forged_date)}</span>
            </div>
            <span class="status-badge status-${key.status}">${key.status.charAt(0).toUpperCase() + key.status.slice(1)}</span>
        `;
        starKeysList.appendChild(keyElement);
    });

    // Add winner information if draw has ended
    if (drawData.status === "ENDED" && drawData.winner) {
        addWinnerSection(drawData);
    }
}

// Function to add winner section for ended draws
function addWinnerSection(drawData) {
    const modalBody = document.querySelector('#drawDetailsModal .modal-body');
    
    // Create winner section
    const winnerSection = document.createElement('div');
    winnerSection.className = 'winner-section';
    winnerSection.style.cssText = `
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.1), rgba(0, 204, 255, 0.1));
        border: 1px solid var(--alien-green);
        border-radius: 10px;
        padding: 1.5rem;
        margin: 2rem 0;
        text-align: center;
    `;
    
    winnerSection.innerHTML = `
        <h4 style="color: var(--alien-green); margin-bottom: 1rem;">
            <i class="fas fa-trophy"></i> Cosmic Champion
        </h4>
        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">
             ${drawData.winner.username || 'Anonymous'}
        </div>
        <div style="font-family: monospace; opacity: 0.8;">
            Winning Key: ${drawData.winner.ticket_serial || drawData.winning_ticket_serial}
        </div>
        ${drawData.winning_keys && drawData.winning_keys.length > 0 ? `
            <div style="margin-top: 1rem;">
                <strong>Winning Combination:</strong>
                <div style="font-family: monospace; letter-spacing: 2px; margin-top: 0.5rem;">
                    ${drawData.winning_keys.join(' - ')}
                </div>
            </div>
        ` : ''}
    `;
    
    // Insert winner section after the info grid
    const infoGrid = modalBody.querySelector('.info-grid');
    infoGrid.parentNode.insertBefore(winnerSection, infoGrid.nextSibling);
}

// Helper function to format date
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    } catch (e) {
        return dateString; // Return original string if parsing fails
    }
}

// Updated viewDraw function
function viewDraw(drawId) {
    // Show loading state immediately
    openModal('drawDetailsModal');
    
    fetchDrawDetails(drawId)
        .then(drawData => {
            populateDrawModal(drawData);
        })
        .catch(error => {
            console.error('Error loading draw details:', error);
            showDrawError(error.message);
        });
}

// CSRF token function (make sure this exists)
function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue || '';
}

// Updated viewDraw function with better error handling
function viewDraw(drawId) {
    // Show loading state immediately
    openModal('drawDetailsModal');
    
    fetchDrawDetails(drawId)
        .then(drawData => {
            populateDrawModal(drawData);
        })
        .catch(error => {
            console.error('Error loading draw details:', error);
            showDrawError(error.message);
        });
}

    // Function to populate modal with draw data
    function populateDrawModal(drawData) {
        document.getElementById('drawDetailTitle').textContent = drawData.title;
        document.getElementById('drawDetailSymbol').textContent = `Symbol: ${drawData.symbol}`;
        document.getElementById('drawDetailPrize').textContent = `${drawData.prize_pool} ASTRA`;
        
        // Update status badge
        const statusElement = document.getElementById('drawDetailStatus');
        statusElement.textContent = drawData.status.charAt(0).toUpperCase() + drawData.status.slice(1);
        statusElement.className = `status-badge status-${drawData.status}`;
        
        document.getElementById('drawDetailDate').textContent = formatDateTime(drawData.draw_datetime);
        document.getElementById('drawDetailParticipants').textContent = drawData.participants.toLocaleString();
        document.getElementById('drawDetailUserKeys').textContent = drawData.user_keys;
        document.getElementById('drawDetailTokenId').textContent = drawData.nft_token_id;
        document.getElementById('drawDetailContract').textContent = drawData.nft_contract;

        // Populate star keys list
        const starKeysList = document.getElementById('drawStarKeysList');
        starKeysList.innerHTML = '';
        
        drawData.star_keys.forEach(key => {
            const keyElement = document.createElement('div');
            keyElement.className = 'star-key-item';
            keyElement.innerHTML = `
                <div>
                    <span style="font-family: monospace; font-weight: 600;">${key.serial}</span>
                    <span style="margin-left: 1rem; font-size: 0.8rem; opacity: 0.7;">Forged: ${formatDate(key.forged_date)}</span>
                </div>
                <span class="status-badge status-${key.status}">${key.status.charAt(0).toUpperCase() + key.status.slice(1)}</span>
            `;
            starKeysList.appendChild(keyElement);
        });
    }

    // Helper function to format date
    function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }

    // Function to show error state
    function showDrawError() {
        const modalBody = document.querySelector('#drawDetailsModal .modal-body');
        modalBody.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--warning-red);">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h3>Unable to Load Draw Details</h3>
                <p>There was an error loading the convergence details. Please try again later.</p>
                <button class="action-btn btn-primary" onclick="closeModal('drawDetailsModal')" style="margin-top: 1rem;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        `;
    }

    // Action functions for modal buttons
    function participateInDraw() {
        const drawId = document.getElementById('drawDetailTitle').textContent;
        alert(`Initiating key forging for: ${drawId}`);
        // Add your participation logic here
        closeModal('drawDetailsModal');
    }

    function shareDraw() {
        const drawTitle = document.getElementById('drawDetailTitle').textContent;
        const drawPrize = document.getElementById('drawDetailPrize').textContent;
        
        // Simple share implementation - you can enhance this
        if (navigator.share) {
            navigator.share({
                title: drawTitle,
                text: `Check out ${drawTitle} with a prize pool of ${drawPrize}!`,
                url: window.location.href
            });
        } else {
            // Fallback: copy to clipboard
            const shareText = `${drawTitle} - Prize: ${drawPrize}\n${window.location.href}`;
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Draw link copied to clipboard!');
            });
        }
    }

    function viewOnExplorer() {
        const tokenId = document.getElementById('drawDetailTokenId').textContent;
        // Open in Hedera Explorer or your preferred blockchain explorer
        window.open(`https://hashscan.io/testnet/token/${tokenId}`, '_blank');
    }
</script>